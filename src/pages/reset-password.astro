---
import Layout from "@/layouts/Layout.astro";
import { RequestPasswordResetForm } from "@/components/auth/RequestPasswordResetForm";
import { SetNewPasswordForm } from "@/components/auth/SetNewPasswordForm";
import { Card } from "@/components/ui/card";

// UWAGA: To jest implementacja UI bez backendu
// Middleware i logika sprawdzania sesji zostanie dodana później

// Odczyt parametrów URL
const type = Astro.url.searchParams.get("type");
const accessToken = Astro.url.searchParams.get("access_token") || undefined;
const refreshToken = Astro.url.searchParams.get("refresh_token") || undefined;
const token = Astro.url.searchParams.get("token") || undefined;
const tokenHashParam = Astro.url.searchParams.get("token_hash") || undefined;
// Dla hosted Supabase używamy token_hash, dla bezpośredniego dostępu token
const tokenHash = tokenHashParam || token || undefined;

const error = Astro.url.searchParams.get("error") || undefined;
const success = Astro.url.searchParams.get("success") || undefined;

// Określ tryb formularza na podstawie parametrów URL
// Jeśli type=recovery i jest token lub token_hash, lub mamy access_token, to tryb ustawiania nowego hasła
// W przeciwnym razie tryb żądania resetu
const mode: "request" | "reset" = type === "recovery" && (token || tokenHash || accessToken) ? "reset" : "request";

// Treść nagłówka w zależności od trybu
const pageTitle = mode === "reset" ? "Ustaw nowe hasło" : "Resetowanie hasła";
const pageDescription = mode === "reset" ? "Wprowadź nowe hasło do swojego konta" : "Nie pamiętasz hasła? Pomożemy Ci!";
---

<Layout title={`${pageTitle} | Billzilla`} showHeader={true}>
  <main class="min-h-screen bg-background flex items-center justify-center p-4">
    <div class="w-full max-w-md">
      <!-- Logo i nagłówek -->
      <div class="text-center mb-8">
        <img
          src="/billzilla-logo.png"
          alt="Billzilla"
          class="h-20 w-20 mx-auto rounded-2xl transition-all duration-300 ease-out hover:scale-105"
        />
        <h1 class="mt-4 text-3xl font-bold tracking-tight text-foreground">
          {pageTitle}
        </h1>
        <p class="mt-2 text-gray-600">
          {pageDescription}
        </p>
      </div>

      <!-- Formularz w karcie -->
      <Card className="bg-white rounded-2xl shadow-md shadow-green-100 p-8">
        {
          mode === "request" ? (
            <RequestPasswordResetForm errorMessage={error} client:load />
          ) : (
            <SetNewPasswordForm
              token={token}
              tokenHash={tokenHash}
              accessToken={accessToken}
              refreshToken={refreshToken}
              errorMessage={error}
              successMessage={success}
              client:load
            />
          )
        }
      </Card>
    </div>
  </main>
</Layout>
